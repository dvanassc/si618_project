ICPSR Weblog Analysis - Bots in the data
========================================================

Understanding the data: Bots
--------------------------------------------------------

### Bot prominence in the web logs

Bots dominate the homepage hits in the weblog data. In total, nearly 90% of the homepage GET requests are generated from bots. These bots range from ICPSR bots, designed to test and check its own data, to Google bots, malicious bots, etc. Our algorithms could not perfectly identify each bot nor the type of bot. Nonetheless, we found it very interesting that bots so heavily make requests to the ICPSR server.

``` {r echo=FALSE, include=FALSE, warning=FALSE}
library(DBI)
library(RSQLite)
driver<-dbDriver("SQLite")
connect<-dbConnect(driver, dbname = "../db/weblogs.db")
log.entries = dbGetQuery(connect, "
select wl.study, class.description, class.code, wl.browser_type,
    case
        when (browser_type like 'Mozilla%' or browser_type like 'Opera%' or browser_type like 'Safari%' or browser_type like 'Nokia%' or browser_type like 'BlackBerry%') and
             (browser_type not like '%Yandex%' and browser_type not like '%spider%' and browser_type not like '%Babya Discover%'
              and browser_type not like '%bot%' and browser_type not like '%Daumoa%' and browser_type not like '%crawler%' and browser_type not like '%LinkCheck%'
              and browser_type not like '%WebCorp%' and browser_type not like '%Yahoo! Slurp%' and browser_type not like '%Genieo%') then 'human'
        else 'bot'
    end as accessor
from weblog_downloads wl left outer join classifications class on wl.study = class.study_id")

log.entries.home = dbGetQuery(connect, "
select wl.study, class.description, class.code, wl.browser_type,
    case
        when (browser_type like 'Mozilla%' or browser_type like 'Opera%' or browser_type like 'Safari%' or browser_type like 'Nokia%' or browser_type like 'BlackBerry%') and
             (browser_type not like '%Yandex%' and browser_type not like '%spider%' and browser_type not like '%Babya Discover%'
              and browser_type not like '%bot%' and browser_type not like '%Daumoa%' and browser_type not like '%crawler%' and browser_type not like '%LinkCheck%'
              and browser_type not like '%WebCorp%' and browser_type not like '%Yahoo! Slurp%' and browser_type not like '%Genieo%') then 'human'
        else 'bot'
    end as accessor
from weblog_homepages wl left outer join classifications class on wl.study = class.study_id")


log.entries$accessor <- factor(log.entries$accessor)
log.entries.home$accessor <- factor(log.entries.home$accessor)

library(ggplot2)
library(plyr)
library(stringr)
library(reshape)
library(scales)

#Homepage
study.sums.home=ddply(log.entries.home, c("study","accessor"), summarise, study_count=length(study))
study.sums.home.reshape=reshape(study.sums.home, timevar="accessor", idvar="study", direction="wide")
study.sums.home.reshape$study_count.human[is.na(study.sums.home.reshape$study_count.human)]=0
study.sums.home.reshape$study_count.bot[is.na(study.sums.home.reshape$study_count.bot)]=0
study.sums.home.reshape$perc=study.sums.home.reshape$study_count.human/(study.sums.home.reshape$study_count.human+study.sums.home.reshape$study_count.bot)


#Download
study.sums=ddply(log.entries, c("study","accessor"), summarise, study_count=length(study))
study.sums.reshape=reshape(study.sums, timevar="accessor", idvar="study", direction="wide")
study.sums.reshape$study_count.human[is.na(study.sums.reshape$study_count.human)]=0
study.sums.reshape$study_count.bot[is.na(study.sums.reshape$study_count.bot)]=0
study.sums.reshape$perc=study.sums.reshape$study_count.human/(study.sums.reshape$study_count.human+study.sums.reshape$study_count.bot)

```

### Graph 1:
The first graph displays the percent of homepage requests for each ICPSR study homepage that are generated by a human. For the vast majority of studies, this rate is nearly 0%.

```{r fig.width=10, echo=FALSE, warning=FALSE}
p5=ggplot(study.sums.home.reshape, aes(x=perc))+geom_histogram(binwidth=.01, alpha=I(.5))+xlab("Percent of homepage hits generated by a human")+ylab("Number of Studies")+scale_x_continuous(labels=percent)+ggtitle("Percent of Homepage Hits Generated by a \nHuman, per study")+theme(axis.title.x = element_text(size = 16), axis.title.y=element_text(size=16), plot.title=element_text(size=24), axis.text.x=element_text(size=14))
print(p5)
```

### Graph 2:
The next graph shows the same data but instead looking at data set downloads rather than homepages. Here, the results are nearly opposite. The vast majority of downloads are done by humans rather than bots.

```{r fig.width=10, echo=FALSE, warning=FALSE}
p6=ggplot(study.sums.reshape, aes(x=perc))+geom_histogram(binwidth=.01, alpha=I(.5))+xlab("Percent of downloads generated by a human")+ylab("Number of Studies")+ggtitle("Percent of Downloads Generated by a Human,\n per study")+scale_x_continuous(labels=percent)+theme(axis.title.x = element_text(size = 16), axis.title.y=element_text(size=16), plot.title=element_text(size=24), axis.text.x=element_text(size=14))
print(p6)

```

### Graph 3:

Each studied is assigned 1 or 2 topics within a 20-topic classification scheme. We wondered whether certain topics were more popular with humans rather than bots. We can tentatively conclude that topics, such as Instructional Packages and Fast Track, tend to attract more humans than bots. Further analysis might explore if these differences are correlated with the number of studies within each classification or the number of hits within each classification.

```{r fig.width=10, echo=FALSE, warning=FALSE}
#Classifications data
class.data=dbGetQuery(connect, "SELECT code, description, study_id FROM classifications")
class.data$majorcode=substr(class.data$code,1,regexpr("([^XVI]|$)??",class.data$code)-1)
class.data$majordesc=substr(class.data$description,1,regexpr("(,|$)??",class.data$description)-1)
class.data$majordesc[class.data$majorcode=="I"]="Census Enumerations"
class.data$majordesc=factor(class.data$majordesc)
class.data=class.data[,c("study_id","majorcode","majordesc")]

study.sums.home.reshape.c=merge(study.sums.home.reshape, class.data, by.x="study", by.y="study_id")

p8=qplot(majordesc,perc, data=study.sums.home.reshape.c)+geom_boxplot(aes(fill=majorcode, colour=majorcode))+scale_y_continuous(labels=percent)+xlab("Classification")+ylab("Percent of homepage hits")+theme(legend.position="none", axis.text.x = element_text(angle=45, hjust=1), axis.title.x = element_text(size = 16), axis.title.y=element_text(size=16), plot.title=element_text(size=24), axis.text.x=element_text(size=14))+ggtitle("Percent of Homepage Hits Generated by\n a Human per Study, By Study Classification")
print(p8)
```